# Generated by Anaconda 40.22.3.26
# Generated by pykickstart v3.52.8
# version=RHEL10
# Use text install
text 

%addon com_redhat_kdump --enable --reserve-mb='auto'

%end

# Keyboard layouts
keyboard --vckeymap=us --xlayouts='us'
# System language
lang en_US.UTF-8

# Disable SELinux & Firewalld
selinux --disabled
firewall --disabled

# Network information
network  --bootproto=dhcp --device=ens160 --ipv6=auto --activate
network  --hostname=lab-base

%packages
@^minimal-environment
%end

%post --interpreter /bin/bash --log=/mnt/root/ks-post.log

# Create vagrant user with password and sudo access
useradd -m -G wheel vagrant
echo "vagrant:vagrant" | chpasswd

# Set up passwordless sudo
echo "vagrant ALL=(ALL) NOPASSWD: ALL" > /etc/sudoers.d/vagrant
chmod 0440 /etc/sudoers.d/vagrant

# Add Vagrant's insecure SSH key
mkdir -p /home/vagrant/.ssh
curl -fsSL https://raw.githubusercontent.com/hashicorp/vagrant/master/keys/vagrant.pub -o /home/vagrant/.ssh/authorized_keys
chmod 600 /home/vagrant/.ssh/authorized_keys
chmod 700 /home/vagrant/.ssh
chown -R vagrant:vagrant /home/vagrant/.ssh

# Passwordless SSH key for root
ssh-keygen -f /root/.ssh/id_ed25519 -q -N ""
cat /root/.ssh/id_ed25519.pub >> /root/.ssh/authorized_keys
chmod 0600 /root/.ssh/authorized_keys

# Enable SSH password auth
sed -i 's/^#\?PasswordAuthentication.*/PasswordAuthentication yes/' /etc/ssh/sshd_config

# Install open-vm-tools, tmux, and update system
dnf update -y && dnf upgrade -y  && dnf install -y open-vm-tools tmux

# Enable and start SSH service on first boot
systemctl enable sshd

# Install and enable open-vm-tools for vagrant
systemctl enable --now vmtoolsd

systemctl restart NetworkManager

%end

# Run the Setup Agent on first boot
firstboot --disable

ignoredisk --only-use=nvme0n1
clearpart --all --initlabel

# Boot partitions
part /boot --fstype="xfs" --ondisk=nvme0n1 --size=600
part /boot/efi --fstype="efi" --ondisk=nvme0n1 --size=300 --fsoptions="umask=0077,shortname=winnt"

# LVM physical volume
part pv.01 --fstype="lvmpv" --ondisk=nvme0n1 --size=9000

# Volume group (no duplicates!)
volgroup rl_lab --pesize=4096 pv.01

# Logical volumes
logvol /opt --fstype="xfs" --size=2048 --name=opt --vgname=rl_lab
logvol /var --fstype="xfs" --size=2048 --name=var --vgname=rl_lab
logvol swap --name=swap --vgname=rl_lab --fstype="swap" --size=1024
logvol / --fstype="xfs" --size=3072 --name=root --vgname=rl_lab

# System timezone
timezone America/Chicago --utc

# Root password
rootpw --iscrypted --allow-ssh $y$j9T$3xrX1kn8Ejul2gfkjCf4qsA2$niqhOpdcedAOWkonmZ67MXDt5jV9PbmQn5fXOEPWhb/

firstboot --disable
eula --agreed
reboot
